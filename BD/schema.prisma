// Que: Schema principal de Prisma para el sistema de reservas
// Para que: Definir todas las tablas, relaciones y tipos de la base de datos
// Impacto: Este archivo genera las migraciones y el cliente tipado de Prisma

generator client {
  // Que: Genera el cliente de Prisma para TypeScript
  // Para que: Hacer queries a la BD con tipado completo
  provider = "prisma-client-js"
}

datasource db {
  // Que: Conexion a PostgreSQL via variable de entorno
  // Para que: No hardcodear credenciales en el codigo
  // Impacto: Cambiar DATABASE_URL en .env segun el entorno
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// TABLA: User
// Que: Almacena clientes y administradores del sistema
// Para que: Gestionar acceso, reservas y comunicacion
// ============================================================
model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  phone     String
  role      UserRole @default(CLIENT)
  isActive  Boolean  @default(true)
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  bookings           Booking[]      @relation("ClientBookings")
  payments           Payment[]
  notifications      Notification[]
  sentMessages       Message[]      @relation("SentMessages")
  receivedMessages   Message[]      @relation("ReceivedMessages")
  createdEvents      Event[]
  createdMaintenances Maintenance[]
  processedPayments  Payment[]      @relation("ProcessedPayments")
  cancelledBookings  Booking[]      @relation("CancelledBookings")

  @@map("users")
}

enum UserRole {
  // Que: Define los roles posibles de un usuario
  CLIENT // Cliente que reserva canchas
  ADMIN  // Administrador del sistema
}

// ============================================================
// TABLA: Field
// Que: Representa la(s) cancha(s) sintetica(s) disponibles
// Para que: Gestionar disponibilidad, precios y caracteristicas
// ============================================================
model Field {
  id                  String        @id @default(cuid())
  name                String
  description         String        @default("")
  pricePerHour        Decimal       @db.Decimal(10, 2)
  surface             SurfaceType   @default(SYNTHETIC)
  lengthMeters        Float         @default(40)
  widthMeters         Float         @default(20)
  capacity            Int
  availableHourStart  String        @default("06:00") // Formato HH:mm
  availableHourEnd    String        @default("22:00") // Formato HH:mm
  slotDurationMinutes Int           @default(60)      // 60, 90 o 120
  amenities           String[]      @default([])
  imageUrls           String[]      @default([])
  isActive            Boolean       @default(true)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  // Relaciones
  bookings     Booking[]
  maintenances Maintenance[]
  events       Event[]

  @@map("fields")
}

enum SurfaceType {
  SYNTHETIC // Sintetica
  NATURAL   // Natural
  CEMENT    // Cemento
}

// ============================================================
// TABLA: Booking
// Que: Nucleo del sistema â€” cada turno reservado
// Para que: Controlar disponibilidad y evitar conflictos de horario
// ============================================================
model Booking {
  id                 String        @id @default(cuid())
  clientId           String
  fieldId            String
  date               DateTime      @db.Date         // Solo fecha, sin hora
  startTime          String                         // "10:00"
  endTime            String                         // "11:00"
  durationMinutes    Int
  status             BookingStatus @default(PENDING)
  totalAmount        Decimal       @db.Decimal(10, 2)
  paymentStatus      PaymentStatus @default(UNPAID)
  promotionId        String?
  discountAmount     Decimal       @default(0)      @db.Decimal(10, 2)
  finalAmount        Decimal       @db.Decimal(10, 2)
  notes              String        @default("")
  adminNotes         String        @default("")
  cancelledAt        DateTime?
  cancelledById      String?
  cancellationReason String        @default("")
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Relaciones
  client      User       @relation("ClientBookings", fields: [clientId], references: [id])
  field       Field      @relation(fields: [fieldId], references: [id])
  promotion   Promotion? @relation(fields: [promotionId], references: [id])
  cancelledBy User?      @relation("CancelledBookings", fields: [cancelledById], references: [id])
  payments    Payment[]

  // Indice compuesto para detectar conflictos de horario (regla critica)
  @@index([fieldId, date, status])
  // Indice para historial de reservas por cliente
  @@index([clientId, date(sort: Desc)])
  @@map("bookings")
}

enum BookingStatus {
  PENDING    // Pendiente de confirmacion
  CONFIRMED  // Confirmada
  CANCELLED  // Cancelada
  COMPLETED  // Completada (ya paso la fecha)
}

enum PaymentStatus {
  UNPAID   // Sin pagar
  PAID     // Pagado
  REFUNDED // Reembolsado
  PARTIAL  // Pago parcial
}

// ============================================================
// TABLA: Payment
// Que: Registra cada transaccion vinculada a una reserva
// Para que: Tener historial de pagos y generar comprobantes
// ============================================================
model Payment {
  id              String                  @id @default(cuid())
  bookingId       String
  clientId        String
  amount          Decimal                 @db.Decimal(10, 2)
  method          PaymentMethod
  status          PaymentTransactionStatus @default(PENDING)
  transactionId   String?                 @unique
  receiptUrl      String?
  receiptNumber   String                  @unique
  notes           String                  @default("")
  processedById   String?
  processedAt     DateTime?
  refundedAt      DateTime?
  refundReason    String                  @default("")
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  // Relaciones
  booking     Booking @relation(fields: [bookingId], references: [id])
  client      User    @relation(fields: [clientId], references: [id])
  processedBy User?   @relation("ProcessedPayments", fields: [processedById], references: [id])

  @@index([bookingId])
  @@index([clientId])
  @@map("payments")
}

enum PaymentMethod {
  CASH       // Efectivo
  CARD       // Tarjeta debito/credito
  TRANSFER   // Transferencia bancaria
  NEQUI      // Nequi
  DAVIPLATA  // Daviplata
}

enum PaymentTransactionStatus {
  PENDING   // Pendiente
  APPROVED  // Aprobado
  REJECTED  // Rechazado
  REFUNDED  // Reembolsado
}

// ============================================================
// TABLA: Maintenance
// Que: Periodos de mantenimiento que bloquean la cancha
// Para que: Evitar reservas en horarios de mantenimiento
// ============================================================
model Maintenance {
  id            String            @id @default(cuid())
  fieldId       String
  title         String
  description   String            @default("")
  startDateTime DateTime
  endDateTime   DateTime
  type          MaintenanceType   @default(SCHEDULED)
  status        MaintenanceStatus @default(PLANNED)
  createdById   String
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Relaciones
  field     Field @relation(fields: [fieldId], references: [id])
  createdBy User  @relation(fields: [createdById], references: [id])

  @@index([fieldId, startDateTime, endDateTime])
  @@map("maintenances")
}

enum MaintenanceType {
  SCHEDULED // Mantenimiento programado
  EMERGENCY // Mantenimiento de emergencia
}

enum MaintenanceStatus {
  PLANNED     // Planificado
  IN_PROGRESS // En progreso
  COMPLETED   // Completado
  CANCELLED   // Cancelado
}

// ============================================================
// TABLA: Event
// Que: Torneos, celebraciones y actividades de la cancha
// Para que: Difundir informacion y gestionar inscripciones
// ============================================================
model Event {
  id                   String      @id @default(cuid())
  title                String
  description          String
  type                 EventType
  status               EventStatus @default(DRAFT)
  startDate            DateTime
  endDate              DateTime?
  imageUrl             String?
  price                Decimal?    @db.Decimal(10, 2)  // null = gratuito
  maxParticipants      Int?                             // null = sin limite
  registeredCount      Int         @default(0)
  fieldId              String?
  createdById          String
  publishedToWhatsApp  Boolean     @default(false)
  publishedToInstagram Boolean     @default(false)
  whatsappMessage      String      @default("")
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt

  // Relaciones
  field     Field? @relation(fields: [fieldId], references: [id])
  createdBy User   @relation(fields: [createdById], references: [id])

  @@index([status, startDate])
  @@map("events")
}

enum EventType {
  TOURNAMENT   // Torneo
  CELEBRATION  // Celebracion / cumpleanos
  PROMOTION    // Promocion especial
  ANNOUNCEMENT // Anuncio general
}

enum EventStatus {
  DRAFT     // Borrador
  PUBLISHED // Publicado
  CANCELLED // Cancelado
  COMPLETED // Completado
}

// ============================================================
// TABLA: Promotion
// Que: Codigos de descuento aplicables a reservas
// Para que: Incentivar reservas con descuentos especiales
// ============================================================
model Promotion {
  id               String       @id @default(cuid())
  name             String
  description      String       @default("")
  code             String       @unique
  discountType     DiscountType
  discountValue    Decimal      @db.Decimal(10, 2)
  minBookingAmount Decimal      @default(0) @db.Decimal(10, 2)
  maxUses          Int          @default(0)  // 0 = sin limite
  usedCount        Int          @default(0)
  validFrom        DateTime
  validUntil       DateTime
  isActive         Boolean      @default(true)
  applicableDays   Int[]        @default([]) // 0=Dom...6=Sab, vacio=todos
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Relaciones
  bookings Booking[]

  @@index([code])
  @@index([isActive, validFrom, validUntil])
  @@map("promotions")
}

enum DiscountType {
  PERCENTAGE // Descuento porcentual (ej: 20%)
  FIXED      // Descuento fijo (ej: $20.000)
}

// ============================================================
// TABLA: Notification
// Que: Historial de notificaciones enviadas a usuarios
// Para que: Rastrear emails, SMS y notificaciones push
// ============================================================
model Notification {
  id           String              @id @default(cuid())
  recipientId  String
  type         NotificationType
  channel      NotificationChannel
  title        String
  message      String
  isRead       Boolean             @default(false)
  readAt       DateTime?
  relatedId    String?             // ID del recurso relacionado (Booking, Event, etc.)
  relatedModel String?             // Nombre del modelo relacionado
  sentAt       DateTime?
  deliveredAt  DateTime?
  failedAt     DateTime?
  errorMessage String?
  createdAt    DateTime            @default(now())

  // Relaciones
  recipient User @relation(fields: [recipientId], references: [id])

  @@index([recipientId, isRead, createdAt(sort: Desc)])
  @@map("notifications")
}

enum NotificationType {
  BOOKING_CONFIRMED   // Reserva confirmada
  BOOKING_CANCELLED   // Reserva cancelada
  BOOKING_REMINDER    // Recordatorio de reserva
  PAYMENT_RECEIVED    // Pago recibido
  EVENT_PUBLISHED     // Evento publicado
  MAINTENANCE_ALERT   // Alerta de mantenimiento
  PROMOTION_AVAILABLE // Promocion disponible
  ADMIN_MESSAGE       // Mensaje del administrador
}

enum NotificationChannel {
  EMAIL  // Correo electronico
  SMS    // Mensaje de texto
  PUSH   // Notificacion push
  IN_APP // Notificacion en la app
}

// ============================================================
// TABLA: Message
// Que: Chat interno entre cliente y administrador
// Para que: Comunicacion directa sin salir del sistema
// ============================================================
model Message {
  id             String   @id @default(cuid())
  senderId       String
  receiverId     String
  content        String
  isRead         Boolean  @default(false)
  readAt         DateTime?
  relatedBookingId String?
  createdAt      DateTime @default(now())

  // Relaciones
  sender  User @relation("SentMessages", fields: [senderId], references: [id])
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id])

  @@index([senderId, receiverId, createdAt])
  @@index([receiverId, isRead])
  @@map("messages")
}
